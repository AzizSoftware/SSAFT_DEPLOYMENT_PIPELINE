pipeline {
  agent any

  environment {
    SSH_CREDENTIALS_ID = 'azure_vm_key'
    APP_REPO_URL = 'https://github.com/AzizSoftware/SSAFT_DEPLOYMENT_PIPELINE.git'
  }

  stages {

    stage('Checkout Repo') {
      steps {
        script {
          checkout([
            $class: 'GitSCM',
            branches: [[name: 'main']],
            userRemoteConfigs: [[url: env.APP_REPO_URL]],
            doNotPoll: true
          ])
        }
      }
    }

    stage('Terraform') {
  steps {
    dir('terraform') {
      withCredentials([
        string(credentialsId: 'azure-subscription-id', variable: 'ARM_SUBSCRIPTION_ID'),
        string(credentialsId: 'azure-client-id', variable: 'ARM_CLIENT_ID'),
        string(credentialsId: 'azure-client-secret', variable: 'ARM_CLIENT_SECRET'),
        string(credentialsId: 'azure-tenant-id', variable: 'ARM_TENANT_ID')
      ]) {
        sh '''
          terraform init
          terraform plan \
            -var="subscription_id=$ARM_SUBSCRIPTION_ID" \
            -var="client_id=$ARM_CLIENT_ID" \
            -var="client_secret=$ARM_CLIENT_SECRET" \
            -var="tenant_id=$ARM_TENANT_ID"

          terraform apply -auto-approve \
            -var="subscription_id=$ARM_SUBSCRIPTION_ID" \
            -var="client_id=$ARM_CLIENT_ID" \
            -var="client_secret=$ARM_CLIENT_SECRET" \
            -var="tenant_id=$ARM_TENANT_ID"
        '''
      }
    }
  }
}

    stage('Ansible Deploy') {
      steps {
        dir('ansible') {
          withCredentials([sshUserPrivateKey(credentialsId: env.SSH_CREDENTIALS_ID, keyFileVariable: 'KEYFILE')]) {
            sh """
              ansible-playbook deploy_app.yml \
                -i inventory.ini \
                --private-key=$KEYFILE \
                -e app_repo_url=../SSATF
            """
          }
        }
      }
    }

    stage('Smoke Test') {
      steps {
        dir('terraform') {
          script {
            def ip = sh(script: "terraform output -raw public_ip_address", returnStdout: true).trim()
            sh "curl --fail http://${ip}:4000"
          }
        }
      }
    }
  }
}
